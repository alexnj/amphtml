name: Sync configuration to the CDN

on:
  push:
    branches:
      - main
    paths:
      - build-system/global-configs/client-side-experiments-config.json
  pull_request:  # DO NOT MERGE

jobs:
  sync:
    if: github.repository == 'ampproject/amphtml'
    name: client-side-experiments-config.json
    runs-on: ubuntu-latest
    environment: wrangler

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2
        with:
          fetch-depth: 1

      - name: Install Dependencies
        run: npm i -g @cloudflare/wrangler

      - run: echo ${{ secrets.CF_API_TOKEN }} | wrangler config
        env:
          RUST_LOG: debug

      - name: ⭐ Sync client-side-experiments-config.json to the CDN ⭐
        run: wrangler kv:key put AMP_EXP "$(cat build-system/global-configs/client-side-experiments-config.json)" --config .github/workflows/wrangler.toml --binding AMP_EXP
        env:
          RUST_LOG: debug
          # CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          # CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
